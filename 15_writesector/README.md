# チュートリアル15 - セクターの書き込み

少しチュートリアル0Bに戻って、SDカードを書き込む機能を追加してみましょう。
これをテストするために、ブートカウンタを実装します。セクタをメモリに読み込んで
（0Bと同じ）、セクタバッファのカウンタを増加させ、SDカードに書き戻します。
こうすることで、このイメージを再起動するたびにカウンタが増加するはずです。

カウンタには、第2セクタの最後の4バイトを選びました。第1セクタは使いたく
ありませんでした。マスタブートレコードが壊れてカードが起動できなくなる
可能性があるからです。第2セクタの方が安全ですが、EFI Partitioning Tableを
使用している場合（私もそうです）は、カウンタがそれを壊してしまう可能性が
あります。そこで、テーブルが508バイトより短いことを期待して、セクタの最後の
4バイトを選びました。もしそうでなければ、COUNTER_SECTOR定義を変更して、
SDカード上の確実に未使用のセクタを指すようにしてください。

徹底的にテストし、コマンド定義中の誤った定数を見つけてくれた[@DamianOslebo](https://github.com/DamianOslebo)に
感謝したいと思います。

## sd.h, sd.c

新しいコマンド（CMD_WRITE_SINGLE, CMD_WRITE_MULTI）と新しいステータスフラグ
（SR_WRITE_AVAILABLE, INT_WRITE_RDY）をドライバに追加しました。これらを*READ*
に対応するものの代わりに使用します。

`sd_writeblock(buffer,lba,num)`は、SDカードのセクタlbaに、バッファからnumブロック
（セクタ）を書き込みます。

## main

メモリのbssセグメントの後のブロックを読み、その中のカウンタを増分し、カードに
保存します。すべてがうまくいけば、実際のカウンタの値をコンソールに表示します。

[メモ](MEMO.md)
